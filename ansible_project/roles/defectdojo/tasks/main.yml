---
# ================================================================
# Role: defectdojo
# Purpose: Install OWASP DefectDojo (Community Edition)
# Network: gitlab_net (shared with GitLab stack)
# ================================================================

- name: Ensure DefectDojo directory exists
  file:
    path: /root/devsecops/defectdojo
    state: directory
    mode: '0755'

- name: Clone DefectDojo repository
  git:
    repo: https://github.com/DefectDojo/django-DefectDojo.git
    dest: /root/devsecops/defectdojo
    version: master
    force: no
    update: yes

- name: Ensure gitlab_net Docker network exists
  shell: docker network inspect gitlab_net || docker network create gitlab_net
  changed_when: false

# âœ… ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ persistent volume Ğ´Ğ»Ñ DefectDojo (Ğ¼ĞµĞ´Ğ¸Ğ° Ğ¸ Ğ±Ğ°Ğ·Ğ°)
- name: Create persistent Docker volumes for DefectDojo
  shell: |
    docker volume inspect defectdojo_data >/dev/null 2>&1 || docker volume create defectdojo_data
    docker volume inspect defectdojo_db >/dev/null 2>&1 || docker volume create defectdojo_db
  changed_when: false

# âœ… Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ docker-compose.override.yml, Ğ½Ğµ Ñ‚Ñ€Ğ¾Ğ³Ğ°Ñ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ compose
- name: Create docker-compose.override.yml with volume bindings
  copy:
    dest: /root/devsecops/defectdojo/docker-compose.override.yml
    content: |
      version: "3.9"
      services:
        uwsgi:
          volumes:
            - defectdojo_data:/app/media
        nginx:
          volumes:
            - defectdojo_data:/app/media
        postgres:
          volumes:
            - defectdojo_db:/var/lib/postgresql/data
      volumes:
        defectdojo_data:
          external: true
        defectdojo_db:
          external: true

- name: Check Docker Compose compatibility
  shell: ./docker/docker-compose-check.sh
  args:
    chdir: /root/devsecops/defectdojo
  register: compose_check
  ignore_errors: yes

- debug:
    msg: "âœ… Docker Compose compatibility check completed."

- name: Build DefectDojo images
  shell: docker compose build
  args:
    chdir: /root/devsecops/defectdojo

- name: Run DefectDojo containers
  shell: docker compose up -d
  args:
    chdir: /root/devsecops/defectdojo

- name: Connect all DefectDojo containers to gitlab_net
  shell: |
    for c in $(docker ps -q --filter "name=defectdojo"); do
      docker network connect gitlab_net $c || true
    done
  changed_when: false

- name: Wait for DefectDojo initializer to complete
  shell: |
    timeout 300 bash -c '
      until docker compose logs initializer 2>/dev/null | grep -q "Admin password:"; do
        echo "Waiting for DefectDojo initializer..."
        sleep 10
      done
    '
  args:
    chdir: /root/devsecops/defectdojo
  register: dojo_init
  ignore_errors: yes

- name: Get DefectDojo admin password
  shell: docker compose logs initializer | grep "Admin password:"
  args:
    chdir: /root/devsecops/defectdojo
  register: admin_pass
  ignore_errors: yes

- debug:
    msg: |
      âœ… DefectDojo deployed successfully!
      ğŸŒ URL: http://10.22.255.224:8080
      ğŸ‘¤ Admin credentials:
      {{ admin_pass.stdout }}
